{"version":3,"file":"install.js","sources":["../src/install.ts"],"sourcesContent":["import { SignalHooks } from '@ember-data/store/-private';\nimport { tagForProperty } from '@ember/-internals/metal';\nimport { consumeTag, createCache, dirtyTag, getValue, track, updateTag, type UpdatableTag } from '@glimmer/validator';\n\nimport { _backburner } from '@ember/runloop';\n// import { createCache, getValue } from '@glimmer/tracking/primitives/cache';\nimport { DEPRECATE_COMPUTED_CHAINS } from '@warp-drive/build-config/deprecations';\nimport { setupSignals } from '@ember-data/store/configure';\n\ntype Tag = ReturnType<typeof tagForProperty>;\nconst emberDirtyTag = dirtyTag as unknown as (tag: Tag) => void;\n\nexport function buildSignalConfig(options: {\n  wellknown: {\n    Array: symbol | string;\n  };\n}) {\n  const ARRAY_SIGNAL = options.wellknown.Array;\n\n  return {\n    createSignal(obj: object, key: string | symbol) {\n      if (DEPRECATE_COMPUTED_CHAINS) {\n        if (key === ARRAY_SIGNAL) {\n          return [tagForProperty(obj, key), tagForProperty(obj, 'length'), tagForProperty(obj, '[]')] as const;\n        }\n      }\n      return tagForProperty(obj, key);\n    },\n    consumeSignal(signal: Tag | [Tag, Tag, Tag]) {\n      if (DEPRECATE_COMPUTED_CHAINS) {\n        if (Array.isArray(signal)) {\n          consumeTag(signal[0]);\n          consumeTag(signal[1]);\n          consumeTag(signal[2]);\n          return;\n        }\n      }\n\n      consumeTag(signal as Tag);\n    },\n    notifySignal(signal: Tag | [Tag, Tag, Tag]) {\n      if (DEPRECATE_COMPUTED_CHAINS) {\n        if (Array.isArray(signal)) {\n          emberDirtyTag(signal[0]);\n          emberDirtyTag(signal[1]);\n          emberDirtyTag(signal[2]);\n          return;\n        }\n      }\n      emberDirtyTag(signal as Tag);\n    },\n    createMemo: <F>(object: object, key: string | symbol, fn: () => F): (() => F) => {\n      if (DEPRECATE_COMPUTED_CHAINS) {\n        const propertyTag = tagForProperty(object, key) as UpdatableTag;\n        const memo = createCache(fn);\n        let ret: F | undefined;\n        const wrappedFn = () => {\n          ret = getValue(memo) as F;\n        };\n        return () => {\n          const tag = track(wrappedFn);\n          updateTag(propertyTag, tag);\n          consumeTag(tag);\n          return ret!;\n        };\n      } else {\n        const memo = createCache(fn);\n        return () => getValue(memo) as F;\n      }\n    },\n    willSyncFlushWatchers: () => {\n      //@ts-expect-error\n      return !!_backburner.currentInstance && _backburner._autorun !== true;\n    },\n  } satisfies SignalHooks<Tag | [Tag, Tag, Tag]>;\n}\n\nsetupSignals(buildSignalConfig);\n"],"names":["emberDirtyTag","dirtyTag","buildSignalConfig","options","ARRAY_SIGNAL","wellknown","Array","createSignal","obj","key","macroCondition","getGlobalConfig","WarpDrive","deprecations","DEPRECATE_COMPUTED_CHAINS","tagForProperty","consumeSignal","signal","isArray","consumeTag","notifySignal","createMemo","object","fn","propertyTag","memo","createCache","ret","wrappedFn","getValue","tag","track","updateTag","willSyncFlushWatchers","_backburner","currentInstance","_autorun","setupSignals"],"mappings":";;;;;;;AAUA,MAAMA,aAAa,GAAGC,QAAyC;AAExD,SAASC,iBAAiBA,CAACC,OAIjC,EAAE;AACD,EAAA,MAAMC,YAAY,GAAGD,OAAO,CAACE,SAAS,CAACC,KAAK;EAE5C,OAAO;AACLC,IAAAA,YAAYA,CAACC,GAAW,EAAEC,GAAoB,EAAE;MAC9C,IAAAC,cAAA,CAAAC,eAAA,EAAA,CAAAC,SAAA,CAAAC,YAAA,CAAAC,yBAAA,CAA+B,EAAA;QAC7B,IAAIL,GAAG,KAAKL,YAAY,EAAE;UACxB,OAAO,CAACW,cAAc,CAACP,GAAG,EAAEC,GAAG,CAAC,EAAEM,cAAc,CAACP,GAAG,EAAE,QAAQ,CAAC,EAAEO,cAAc,CAACP,GAAG,EAAE,IAAI,CAAC,CAAC;AAC7F;AACF;AACA,MAAA,OAAOO,cAAc,CAACP,GAAG,EAAEC,GAAG,CAAC;KAChC;IACDO,aAAaA,CAACC,MAA6B,EAAE;MAC3C,IAAAP,cAAA,CAAAC,eAAA,EAAA,CAAAC,SAAA,CAAAC,YAAA,CAAAC,yBAAA,CAA+B,EAAA;AAC7B,QAAA,IAAIR,KAAK,CAACY,OAAO,CAACD,MAAM,CAAC,EAAE;AACzBE,UAAAA,UAAU,CAACF,MAAM,CAAC,CAAC,CAAC,CAAC;AACrBE,UAAAA,UAAU,CAACF,MAAM,CAAC,CAAC,CAAC,CAAC;AACrBE,UAAAA,UAAU,CAACF,MAAM,CAAC,CAAC,CAAC,CAAC;AACrB,UAAA;AACF;AACF;MAEAE,UAAU,CAACF,MAAa,CAAC;KAC1B;IACDG,YAAYA,CAACH,MAA6B,EAAE;MAC1C,IAAAP,cAAA,CAAAC,eAAA,EAAA,CAAAC,SAAA,CAAAC,YAAA,CAAAC,yBAAA,CAA+B,EAAA;AAC7B,QAAA,IAAIR,KAAK,CAACY,OAAO,CAACD,MAAM,CAAC,EAAE;AACzBjB,UAAAA,aAAa,CAACiB,MAAM,CAAC,CAAC,CAAC,CAAC;AACxBjB,UAAAA,aAAa,CAACiB,MAAM,CAAC,CAAC,CAAC,CAAC;AACxBjB,UAAAA,aAAa,CAACiB,MAAM,CAAC,CAAC,CAAC,CAAC;AACxB,UAAA;AACF;AACF;MACAjB,aAAa,CAACiB,MAAa,CAAC;KAC7B;AACDI,IAAAA,UAAU,EAAEA,CAAIC,MAAc,EAAEb,GAAoB,EAAEc,EAAW,KAAgB;MAC/E,IAAAb,cAAA,CAAAC,eAAA,EAAA,CAAAC,SAAA,CAAAC,YAAA,CAAAC,yBAAA,CAA+B,EAAA;AAC7B,QAAA,MAAMU,WAAW,GAAGT,cAAc,CAACO,MAAM,EAAEb,GAAG,CAAiB;AAC/D,QAAA,MAAMgB,IAAI,GAAGC,WAAW,CAACH,EAAE,CAAC;AAC5B,QAAA,IAAII,GAAkB;QACtB,MAAMC,SAAS,GAAGA,MAAM;AACtBD,UAAAA,GAAG,GAAGE,QAAQ,CAACJ,IAAI,CAAM;SAC1B;AACD,QAAA,OAAO,MAAM;AACX,UAAA,MAAMK,GAAG,GAAGC,KAAK,CAACH,SAAS,CAAC;AAC5BI,UAAAA,SAAS,CAACR,WAAW,EAAEM,GAAG,CAAC;UAC3BX,UAAU,CAACW,GAAG,CAAC;AACf,UAAA,OAAOH,GAAG;SACX;AACH,OAAC,MAAM;AACL,QAAA,MAAMF,IAAI,GAAGC,WAAW,CAACH,EAAE,CAAC;AAC5B,QAAA,OAAO,MAAMM,QAAQ,CAACJ,IAAI,CAAM;AAClC;KACD;IACDQ,qBAAqB,EAAEA,MAAM;AAC3B;MACA,OAAO,CAAC,CAACC,WAAW,CAACC,eAAe,IAAID,WAAW,CAACE,QAAQ,KAAK,IAAI;AACvE;GACD;AACH;AAEAC,YAAY,CAACnC,iBAAiB,CAAC;;;;"}